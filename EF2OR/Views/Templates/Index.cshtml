@model List<EF2OR.ViewModels.TemplateViewModel>
@{
    ViewBag.Title = "Templates";
    var exportActionUrl = Url.Action("Index", "Export", new { }, Request.Url.Scheme) + "/";
}

<style>
    .accordionHeader {
        width: 100%;
        text-align: left;
    }

    #DataPreview .table td {
        white-space: nowrap;
    }
</style>

<h3>@ViewBag.Title</h3>
<link href="~/Content/jquery.modal.min.css" rel="stylesheet" />

<div>
    <table class="table table-striped">
        <tr>
            <th>Template Name</th>
            <th>Vendor</th>
            <th>Access URL</th>
            <th>Access Token</th>
            <th># of Downloads</th>
            <th>Last Access</th>
            <th>Actions</th>
        </tr>
        @foreach (var template in Model)
        {
            var tokenText = string.IsNullOrEmpty(template.AccessToken) ? "Assign Token" : "Generate New Token";
            <tr>
                <td>@template.TemplateName</td>
                <td>@template.VendorName</td>
                <td>@(string.IsNullOrEmpty(template.AccessUrl) ? "" : exportActionUrl + template.AccessUrl)</td>
                <td>@template.AccessToken</td>
                <td>@template.NumberOfDownloads</td>
                <td>@template.LastAccess</td>
                <td>
                    <a href="javascript:dataPreview(@template.TemplateId);">Preview</a> |
                    <a href="javascript:dataDownload(@template.TemplateId);">Download</a> |
                    <a href="@Url.Action("Index", "Logs", new { templateId = template.TemplateId })">View Log</a> |
                    <a href="javascript:openCloneWindow(@template.TemplateId);">Clone</a> |
                    <a href="javascript:openEditWindow(@template.TemplateId, '@template.TemplateName', '@template.VendorName');">Edit</a> |
                    <a href="javascript:deleteTemplate(@template.TemplateId);">Delete</a> |
                    @Html.ActionLink(tokenText, "AssignToken", new { templateId = template.TemplateId })
                </td>
            </tr>
        }
    </table>

    <div id="DataPreview"></div>
</div>



@section BodyOutsideOfContainer{
    <div style="position:fixed; bottom:40px; padding:10px; background-color: white; width:100%;">
        <a href="@Url.Action("Index", "Exports")" class="btn btn-primary">Create New Template</a>
    </div>
}


<div id="editWindow" style="display:none;">
    <input type="hidden" id="editTemplateId" />

    <h4 align="center" id="modalHeader"></h4>

    <div class="form-group">
        <label class="col-md-6 control-label">Template Name:</label>
        <div class="col-md-6">
            <input type="text" class="form-control" id="editTemplateName" />
        </div>
    </div>
    <br />
    <br />
    <div class="form-group">
        <label class="col-md-6 control-label">Vendor Name:</label>
        <div class="col-md-6">
            <input type="text" class="form-control" id="editTemplateVendorName" />
        </div>
    </div>
    <br />
    <br />
    <div style="text-align:center;">
        <button type="button" class="btn btn-primary" id="cloneSave" onclick="cloneTemplate()">Save and Review Filters</button>
        <button type="button" class="btn btn-primary" id="editSave" onclick="editTemplate()">Save</button>
        <a href="#" class="btn btn-primary" rel="modal:close">Cancel</a>
    </div>
</div>


@section scripts{
<script src="~/Scripts/jquery.modal.min.js"></script>
  <script>
      function dataPreview(templateId) {
          $('#DataPreview').html('<div style="width: 100%; text-align:center;"><img src="@Url.Content("~/Content/Images/loading.gif")" style="width: 64px;" /><h4>Loading...</h4></div>');

          $("#DataPreview").load("@Url.Action("PreviewFromTemplate", "Exports")", {
              templateId: templateId
          });
      }

      function dataDownload(templateId) {
          window.location = "@Url.Action("Download")?templateId=" + templateId;
      }

      function openEditWindow(templateId, templateName, vendorName) {
          $("#editTemplateId").val(templateId);
          $("#editTemplateName").val(templateName);
          $("#editTemplateVendorName").val(vendorName);
          $("#cloneSave").hide();
          $("#editSave").show();
          $("#modalHeader").text("Edit Template");

          $("#editWindow").modal({
              showClose: false
          });
      }

      function openCloneWindow(templateId) {
          $("#editTemplateId").val(templateId);
          $("#editTemplateName").val("");
          $("#editTemplateVendorName").val("");
          $("#editSave").hide();
          $("#cloneSave").show();
          $("#modalHeader").text("Clone Template");

          $("#editWindow").modal({
              showClose: false
          });
      }

      function editTemplate() {
          var editTemplateId = $("#editTemplateId").val();
          var editTemplateName = $("#editTemplateName").val();
          var editTemplateVendorName = $("#editTemplateVendorName").val();

          var url = "@Url.Action("Edit")";
          url += "?templateId=" + editTemplateId;
          url += "&templateName=" + editTemplateName;
          url += "&vendorName=" + editTemplateVendorName;

          window.location.href = url;
      }

      function cloneTemplate() {
          var editTemplateId = $("#editTemplateId").val();
          var editTemplateName = $("#editTemplateName").val();
          var editTemplateVendorName = $("#editTemplateVendorName").val();

          var url = "@Url.Action("Clone")";
          url += "?templateId=" + editTemplateId;
          url += "&templateName=" + editTemplateName;
          url += "&vendorName=" + editTemplateVendorName;

          window.location.href = url;
      }

      function deleteTemplate(templateId) {
          if (confirm("Are you sure you want to delete this Template?")) {
              var url = "@Url.Action("Delete")?templateId=" + templateId;
              window.location.href = url;
          }
      }
    </script>   
}